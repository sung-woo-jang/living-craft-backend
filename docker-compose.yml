# Docker Compose 버전 지정 (현재 3.8 버전 사용)
version: '3.8'

# 여러 개의 서비스(컨테이너)를 정의하는 섹션
services:
  # PostgreSQL 데이터베이스 서비스
  postgres:
    # 사용할 Docker 이미지 (PostgreSQL 15 버전의 Alpine Linux)
    image: postgres:15-alpine
    # 컨테이너 이름을 직접 지정 (docker ps에서 보이는 이름)
    container_name: reservation-postgres
    # 컨테이너가 중지되면 자동으로 재시작 (시스템 종료시는 제외)
    restart: unless-stopped
    # 환경변수 설정 (PostgreSQL 초기 설정)
    environment:
      # 데이터베이스 이름 (.env에서 값을 가져오고, 없으면 기본값 사용)
      POSTGRES_DB: ${DB_DATABASE:-reservation_db}
      # PostgreSQL 사용자 이름
      POSTGRES_USER: ${DB_USERNAME:-reservation_user}
      # PostgreSQL 사용자 비밀번호
      POSTGRES_PASSWORD: ${DB_PASSWORD:-reservation_password}
    # 포트 매핑 (호스트:컨테이너)
    # 호스트의 5432 포트를 컨테이너의 5432 포트에 연결
    ports:
      - "${DB_PORT:-5432}:5432"
    # 볼륨 마운팅 (데이터 영구 저장)
    volumes:
      # PostgreSQL 데이터를 postgres_data 볼륨에 저장
      - postgres_data:/var/lib/postgresql/data
      # 초기 SQL 스크립트를 컨테이너에 복사 (데이터베이스 생성시 자동 실행)
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    # 네트워크 설정 (같은 네트워크의 컨테이너들끼리 통신 가능)
    networks:
      - reservation-network
    # 헬스체크 설정 (컨테이너가 정상 작동하는지 확인)
    healthcheck:
      # PostgreSQL에 연결 테스트를 하는 명령어
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-reservation_user} -d ${DB_DATABASE:-reservation_db}"]
      # 10초마다 헬스체크 실행
      interval: 10s
      # 5초 안에 응답이 없으면 실패로 간주
      timeout: 5s
      # 5번 연속 실패하면 unhealthy 상태로 변경
      retries: 5

  # Redis 캐시 서비스 (세션 저장, 캐싱 용도)
  redis:
    # Redis 7 버전의 Alpine Linux 이미지 사용
    image: redis:7-alpine
    container_name: reservation-redis
    restart: unless-stopped
    ports:
      # 호스트의 6379 포트를 컨테이너의 6379 포트에 연결
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      # Redis 데이터를 redis_data 볼륨에 저장
      - redis_data:/data
    networks:
      - reservation-network
    healthcheck:
      # Redis에 ping 명령어를 보내서 연결 테스트
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NestJS 애플리케이션 서비스
  app:
    # 현재 디렉토리의 Dockerfile을 사용해서 이미지 빌드
    build:
      # 빌드 컨텍스트 (Dockerfile이 있는 위치)
      context: .
      # 사용할 Dockerfile 이름
      dockerfile: Dockerfile
    container_name: reservation-app
    restart: unless-stopped
    ports:
      # 호스트의 3000 포트를 컨테이너의 3000 포트에 연결
      - "${PORT:-3000}:3000"
    # 애플리케이션에서 사용할 환경변수들
    environment:
      # Node.js 실행 환경
      - NODE_ENV=${NODE_ENV:-production}
      # 데이터베이스 연결 정보 (서비스 이름으로 연결)
      - DB_HOST=postgres  # Docker Compose에서는 서비스 이름으로 접근
      - DB_PORT=5432
      - DB_DATABASE=${DB_DATABASE:-reservation_db}
      - DB_USERNAME=${DB_USERNAME:-reservation_user}
      - DB_PASSWORD=${DB_PASSWORD:-reservation_password}
      # Redis 연결 정보
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # JWT 인증 관련
      - JWT_SECRET=${JWT_SECRET}
      # 네이버 OAuth 관련
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - NAVER_CALLBACK_URL=${NAVER_CALLBACK_URL}
      # 관리자 계정 정보
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      # 네이버 클라우드 플랫폼 API 키들
      - NCP_ACCESS_KEY=${NCP_ACCESS_KEY}
      - NCP_SECRET_KEY=${NCP_SECRET_KEY}
      - NCP_SERVICE_ID=${NCP_SERVICE_ID}
      - NCP_CALLING_NUMBER=${NCP_CALLING_NUMBER}
    # 볼륨 마운팅 (호스트와 컨테이너 간 파일 공유)
    volumes:
      # 업로드된 파일들을 호스트에 저장 (컨테이너가 재시작되어도 유지)
      - ./uploads:/app/uploads
      # 로그 파일들을 호스트에 저장
      - ./logs:/app/logs
    # 의존성 설정 (다른 서비스가 healthy 상태가 된 후에 시작)
    depends_on:
      postgres:
        # PostgreSQL이 healthy 상태일 때까지 대기
        condition: service_healthy
      redis:
        # Redis가 healthy 상태일 때까지 대기
        condition: service_healthy
    networks:
      - reservation-network
    # 애플리케이션 헬스체크
    healthcheck:
      # /health 엔드포인트에 HTTP 요청을 보내서 확인
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      # 30초마다 헬스체크 실행
      interval: 30s
      # 10초 안에 응답이 없으면 실패
      timeout: 10s
      # 3번 연속 실패하면 unhealthy 상태
      retries: 3

  # Nginx 리버스 프록시 서비스 (선택사항)
  nginx:
    # Nginx Alpine 이미지 사용
    image: nginx:alpine
    container_name: reservation-nginx
    restart: unless-stopped
    ports:
      # HTTP 트래픽을 위한 80 포트
      - "80:80"
      # HTTPS 트래픽을 위한 443 포트
      - "443:443"
    volumes:
      # Nginx 설정 파일을 읽기 전용으로 마운트
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL 인증서 파일들을 읽기 전용으로 마운트
      - ./ssl:/etc/nginx/ssl:ro
      # 정적 파일(업로드된 파일)들을 읽기 전용으로 서빙
      - ./uploads:/var/www/uploads:ro
    # app 서비스가 시작된 후에 nginx 시작
    depends_on:
      - app
    networks:
      - reservation-network

# 볼륨 정의 (데이터 영구 저장을 위한 볼륨들)
volumes:
  # PostgreSQL 데이터를 저장할 볼륨
  postgres_data:
    # 로컬 드라이버 사용 (호스트의 디스크에 저장)
    driver: local
  # Redis 데이터를 저장할 볼륨
  redis_data:
    driver: local

# 네트워크 정의 (컨테이너들 간의 통신을 위한 네트워크)
networks:
  # 예약 서비스 전용 네트워크
  reservation-network:
    # 브리지 드라이버 사용 (Docker의 기본 네트워크 타입)
    driver: bridge
