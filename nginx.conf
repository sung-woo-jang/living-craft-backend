# Nginx 사용자 설정 (기본 nginx 사용자로 실행)
user nginx;

# 워커 프로세스 수 자동 설정 (CPU 코어 수에 맞춰 자동 조정)
worker_processes auto;

# 에러 로그 파일 위치와 로그 레벨 설정
error_log /var/log/nginx/error.log warn;

# Nginx 마스터 프로세스의 PID 파일 위치
pid /var/run/nginx.pid;

# 이벤트 처리 블록 (연결 처리 방식 설정)
events {
    # 각 워커 프로세스가 동시에 처리할 수 있는 연결 수
    worker_connections 1024;

    # Linux에서 효율적인 이벤트 처리 방식인 epoll 사용
    use epoll;

    # 한 번에 여러 개의 새로운 연결을 받을 수 있도록 설정 (성능 향상)
    multi_accept on;
}

# HTTP 서버 설정 블록
http {
    # MIME 타입 설정 파일 포함 (파일 확장자별로 올바른 Content-Type 설정)
    include /etc/nginx/mime.types;

    # 기본 MIME 타입 (알 수 없는 파일은 이진 파일로 처리)
    default_type application/octet-stream;

    # 액세스 로그 형식 정의
    # $remote_addr: 클라이언트 IP
    # $remote_user: 인증된 사용자명
    # $time_local: 로컬 시간
    # $request: HTTP 요청 라인 (메소드, URI, 버전)
    # $status: HTTP 응답 상태 코드
    # $body_bytes_sent: 전송된 바이트 수
    # $http_referer: 이전 페이지 URL
    # $http_user_agent: 사용자 브라우저 정보
    # $http_x_forwarded_for: 프록시를 거친 실제 클라이언트 IP
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # 액세스 로그 파일 위치와 사용할 형식 지정
    access_log /var/log/nginx/access.log main;

    # 기본 성능 설정들
    # sendfile: 파일 전송 시 커널 레벨에서 처리하여 성능 향상
    sendfile on;

    # tcp_nopush: sendfile과 함께 사용하여 네트워크 효율성 향상
    tcp_nopush on;

    # tcp_nodelay: 작은 패킷도 즉시 전송 (지연 감소)
    tcp_nodelay on;

    # 연결 유지 시간 (65초 후 자동으로 연결 종료)
    keepalive_timeout 65;

    # 해시 테이블 최대 크기 설정
    types_hash_max_size 2048;

    # 클라이언트가 업로드할 수 있는 최대 파일 크기 (10MB)
    client_max_body_size 10M;

    # Gzip 압축 설정 (파일 크기 줄여서 전송 속도 향상)
    gzip on;
    # 프록시된 요청에도 압축 적용
    gzip_vary on;
    # 모든 프록시 요청에 압축 적용
    gzip_proxied any;
    # 압축 레벨 (1-9, 6은 적당한 압축률과 CPU 사용량의 균형)
    gzip_comp_level 6;
    # 압축할 파일 타입들 지정
    gzip_types
        text/plain          # 일반 텍스트
        text/css           # CSS 파일
        text/xml           # XML 파일
        text/javascript    # JavaScript 파일
        application/javascript  # JS 애플리케이션
        application/xml+rss     # RSS 피드
        application/json;       # JSON 데이터

    # API 요청 제한 설정 (DDoS 공격 방지)
    # $binary_remote_addr: 클라이언트 IP를 바이너리로 변환 (메모리 절약)
    # zone=api:10m: 'api'라는 이름의 10MB 메모리 공간 할당
    # rate=30r/m: 분당 30개 요청 제한
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;

    # 로그인 요청은 더 엄격하게 제한 (무차별 대입 공격 방지)
    # rate=5r/m: 분당 5개 로그인 시도만 허용
    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

    # 백엔드 서버 그룹 정의 (로드 밸런싱)
    upstream backend {
        # Docker Compose의 'app' 서비스를 backend로 지정
        server app:3000;
        # 연결 풀링: 32개의 연결을 유지하여 성능 향상
        keepalive 32;
    }

    # HTTP 서버 블록 (가상 호스트 설정)
    server {
        # 80번 포트에서 HTTP 요청 대기
        listen 80;
        # 서버 이름 (도메인명, 개발환경에서는 localhost 사용)
        server_name localhost;

        # 보안 헤더들 추가 (웹 보안 강화)
        # X-Frame-Options: 다른 사이트에서 iframe으로 포함하는 것을 방지
        add_header X-Frame-Options "SAMEORIGIN" always;
        # XSS 공격 방지를 위한 브라우저 보안 기능 활성화
        add_header X-XSS-Protection "1; mode=block" always;
        # MIME 타입 스니핑 방지 (보안 취약점 차단)
        add_header X-Content-Type-Options "nosniff" always;
        # 리퍼러 정책 설정 (개인정보 보호)
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        # Content Security Policy: XSS 공격 방지를 위한 콘텐츠 정책
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

        # API 요청 프록시 설정
        location /api/ {
            # API 호출 제한 적용: 버스트 10개까지 허용, 즉시 처리
            # burst=10: 순간적으로 10개까지 요청 허용
            # nodelay: 대기 없이 즉시 처리
            limit_req zone=api burst=10 nodelay;

            # 백엔드 서버로 요청 전달
            proxy_pass http://backend;
            # HTTP/1.1 프로토콜 사용
            proxy_http_version 1.1;
            # WebSocket 지원을 위한 헤더 설정
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            # 원본 호스트 정보 전달
            proxy_set_header Host $host;
            # 실제 클라이언트 IP 전달
            proxy_set_header X-Real-IP $remote_addr;
            # 프록시 체인을 통한 IP 정보 전달
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 프로토콜 정보 전달 (HTTP/HTTPS)
            proxy_set_header X-Forwarded-Proto $scheme;
            # 캐시 우회 설정
            proxy_cache_bypass $http_upgrade;
        }

        # 로그인 요청에 대한 특별한 제한 (보안 강화)
        location /api/auth/admin/login {
            # 로그인 시도 제한: 버스트 3개까지, 즉시 처리
            limit_req zone=login burst=3 nodelay;

            # 백엔드로 프록시 (위와 동일한 설정)
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 헬스체크 요청은 로깅하지 않음 (로그 파일 크기 절약)
        location /health {
            proxy_pass http://backend;
            # 액세스 로그 비활성화
            access_log off;
        }

        # 정적 파일 서빙 (업로드된 파일들)
        location /uploads/ {
            # 실제 파일 위치 지정
            alias /var/www/uploads/;
            # 캐시 설정: 1년간 브라우저에서 캐시
            expires 1y;
            # 캐시 제어 헤더 (변경되지 않는 파일임을 명시)
            add_header Cache-Control "public, immutable";

            # 업로드된 파일 중 실행 가능한 파일들의 접근 차단 (보안)
            location ~* \.(php|jsp|asp|sh|cgi)$ {
                # 모든 접근 차단
                deny all;
            }
        }

        # 루트 경로와 기타 모든 요청을 백엔드로 전달
        location / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 에러 페이지 설정
        # 404 에러 (페이지를 찾을 수 없음)
        error_page 404 /404.html;
        # 5xx 서버 에러들 (500, 502, 503, 504)
        error_page 500 502 503 504 /50x.html;

        # 에러 페이지 파일 위치
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

    # HTTPS 설정 (SSL 인증서가 있을 때 주석 해제)
    # server {
    #     # 443번 포트에서 SSL/TLS와 HTTP/2 지원
    #     listen 443 ssl http2;
    #     server_name yourdomain.com;
    #
    #     # SSL 인증서 파일들 지정
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     # 지원할 SSL/TLS 프로토콜 버전 (보안을 위해 1.2 이상만)
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     # 암호화 방식 설정 (강력한 암호화 방식들만 사용)
    #     ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    #     # 클라이언트가 아닌 서버의 암호화 방식 우선 사용
    #     ssl_prefer_server_ciphers off;
    #
    #     # 위의 HTTP 설정과 동일한 location 블록들 적용
    # }
}
